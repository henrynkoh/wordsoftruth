<% content_for :title, "âœï¸ ìƒˆ ì˜ì  ë…¸íŠ¸ ì‘ì„±" %>

<div class="container mx-auto px-4 py-6 max-w-2xl">
  <!-- Header -->
  <div class="mb-6">
    <%= link_to text_notes_path, class: "text-blue-600 hover:text-blue-800 text-sm flex items-center mb-3" do %>
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      í…ìŠ¤íŠ¸ ë…¸íŠ¸ë¡œ ëŒì•„ê°€ê¸°
    <% end %>
    
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">âœï¸ ìƒˆ ì˜ì  ë…¸íŠ¸ ì‘ì„±</h1>
    <p class="text-gray-600">ì˜ê°ê³¼ ë¬µìƒì„ ì ì–´ì£¼ì„¸ìš”. AIê°€ ìë™ìœ¼ë¡œ ì ì ˆí•œ í…Œë§ˆë¥¼ ì„ íƒí•˜ê³  YouTube Shortsë¡œ ë³€í™˜í•©ë‹ˆë‹¤.</p>
  </div>

  <!-- Quick Templates (Mobile-friendly) -->
  <div class="bg-blue-50 rounded-lg p-4 mb-6">
    <h3 class="font-semibold text-blue-900 mb-3">ğŸ“‹ ë¹ ë¥¸ ì‹œì‘ í…œí”Œë¦¿</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
      <button onclick="fillTemplate('prayer')" class="text-left p-3 bg-white rounded-lg hover:bg-blue-100 transition-colors text-sm">
        ğŸ™ <strong>ê¸°ë„ ì œëª©:</strong> "í•˜ë‚˜ë‹˜ê»˜ ê°„êµ¬í•©ë‹ˆë‹¤..."
      </button>
      <button onclick="fillTemplate('devotion')" class="text-left p-3 bg-white rounded-lg hover:bg-blue-100 transition-colors text-sm">
        ğŸ“– <strong>ì¼ì¼ ê²½ê±´:</strong> "ì˜¤ëŠ˜ í•˜ë£¨ë„ ì£¼ë‹˜ê³¼ í•¨ê»˜..."
      </button>
      <button onclick="fillTemplate('testimony')" class="text-left p-3 bg-white rounded-lg hover:bg-blue-100 transition-colors text-sm">
        âœ¨ <strong>ê°„ì¦:</strong> "í•˜ë‚˜ë‹˜ì˜ ì€í˜œë¥¼ ê°„ì¦í•©ë‹ˆë‹¤..."
      </button>
      <button onclick="fillTemplate('reflection')" class="text-left p-3 bg-white rounded-lg hover:bg-blue-100 transition-colors text-sm">
        ğŸ’­ <strong>ê°œì¸ ë¬µìƒ:</strong> "ì£¼ë‹˜ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤..."
      </button>
    </div>
  </div>

  <!-- Form -->
  <%= form_with model: @text_note, local: true, class: "space-y-6", id: "text-note-form" do |form| %>
    <% if @text_note.errors.any? %>
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <h4 class="text-red-800 font-semibold mb-2">ë‹¤ìŒ ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”:</h4>
        <ul class="text-red-700 text-sm space-y-1">
          <% @text_note.errors.full_messages.each do |message| %>
            <li>â€¢ <%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Title (Optional) -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        ì œëª© (ì„ íƒì‚¬í•­)
      </label>
      <%= form.text_field :title, 
          placeholder: "ì˜ˆ: ì˜¤ëŠ˜ì˜ ê¸°ë„, ì„±ê²½ ë¬µìƒ ë“±...", 
          class: "w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
    </div>

    <!-- Main Text Content -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        ì˜ì  ë…¸íŠ¸ ë‚´ìš© <span class="text-red-500">*</span>
      </label>
      <%= form.text_area :content, 
          rows: 8,
          placeholder: "ë§ˆìŒì— ë– ì˜¤ë¥¸ ì˜ì  ìƒê°, ê¸°ë„ ì œëª©, ì„±ê²½ ë¬µìƒ, ê°„ì¦ ë“±ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”...\n\nì˜ˆì‹œ:\nâ€¢ í•˜ë‚˜ë‹˜ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤. ì˜¤ëŠ˜ë„ ì£¼ë‹˜ì˜ ì€í˜œë¡œ...\nâ€¢ ì‹œí¸ 23í¸ì„ ì½ìœ¼ë©° ì„ í•œ ëª©ìì´ì‹  ì£¼ë‹˜ì„...\nâ€¢ ì–´ë ¤ìš´ ìƒí™©ì—ì„œë„ ì£¼ë‹˜ì„ ì‹ ë¢°í•©ë‹ˆë‹¤...", 
          class: "w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent",
          id: "content-textarea" %>
      
      <!-- Character Counter -->
      <div class="flex justify-between items-center mt-2 text-sm text-gray-500">
        <span id="char-count">0ì / 800ì</span>
        <span id="estimated-duration">ì˜ˆìƒ ê¸¸ì´: 10ì´ˆ</span>
      </div>
    </div>

    <!-- Note Type Selection -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-3">
        ë…¸íŠ¸ ìœ í˜• (AIê°€ ìë™ ê°ì§€í•˜ì§€ë§Œ ì§ì ‘ ì„ íƒë„ ê°€ëŠ¥)
      </label>
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
        <% TextNote.note_types.each do |key, value| %>
          <label class="relative">
            <%= form.radio_button :note_type, key, 
                class: "sr-only peer",
                checked: (@text_note.note_type == key) %>
            <div class="border-2 border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:border-blue-300 peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-colors">
              <div class="text-lg mb-1"><%= get_note_type_emoji(key) %></div>
              <div class="text-sm font-medium"><%= get_note_type_display(key) %></div>
            </div>
          </label>
        <% end %>
      </div>
    </div>

    <!-- Theme Selection -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-3">
        ì˜ìƒ í…Œë§ˆ <span class="text-gray-500">(AI ìë™ ì„ íƒ ê¶Œì¥)</span>
      </label>
      
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
        <!-- Auto Detect Option -->
        <label class="relative">
          <%= form.radio_button :theme, 'auto_detect', 
              class: "sr-only peer",
              checked: (@text_note.theme == 'auto_detect' || @text_note.theme.nil?) %>
          <div class="border-2 border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:border-blue-300 peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-colors">
            <div class="text-lg mb-1">ğŸ¤–</div>
            <div class="text-sm font-medium">AI ìë™ ì„ íƒ</div>
            <div class="text-xs text-gray-500">ì¶”ì²œ</div>
          </div>
        </label>
        
        <!-- Manual Theme Options -->
        <% TextNote.themes.reject { |k, v| k == 'auto_detect' }.each do |key, value| %>
          <label class="relative">
            <%= form.radio_button :theme, key, 
                class: "sr-only peer" %>
            <div class="border-2 border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:border-blue-300 peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-colors">
              <div class="text-lg mb-1"><%= get_theme_emoji(key) %></div>
              <div class="text-sm font-medium"><%= get_theme_display(key) %></div>
            </div>
          </label>
        <% end %>
      </div>
    </div>

    <!-- AI Preview (Dynamic) -->
    <div id="ai-preview" class="bg-gray-50 rounded-lg p-4 hidden">
      <h4 class="font-semibold text-gray-900 mb-2">ğŸ¤– AI ë¶„ì„ ë¯¸ë¦¬ë³´ê¸°</h4>
      <div class="space-y-2 text-sm">
        <div>ê°ì§€ëœ í…Œë§ˆ: <span id="detected-theme" class="font-medium"></span></div>
        <div>ì˜ˆìƒ ë…¸íŠ¸ ìœ í˜•: <span id="detected-type" class="font-medium"></span></div>
        <div>í•œêµ­ì–´ ê¸€ììˆ˜: <span id="korean-chars" class="font-medium"></span></div>
        <div>ì˜ˆìƒ ì˜ìƒ ê¸¸ì´: <span id="video-duration" class="font-medium"></span></div>
      </div>
    </div>

    <!-- Submit Buttons -->
    <div class="flex flex-col sm:flex-row gap-3">
      <%= form.submit "ğŸ¬ ì˜ìƒ ìƒì„± ì‹œì‘", 
          class: "flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 transition-colors font-medium" %>
      
      <%= link_to "ì·¨ì†Œ", text_notes_path, 
          class: "flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-200 focus:ring-2 focus:ring-gray-500 transition-colors font-medium text-center" %>
    </div>
  <% end %>
</div>

<!-- JavaScript for Enhanced Mobile Experience -->
<script>
// Template filling
const templates = {
  prayer: "í•˜ë‚˜ë‹˜ê»˜ ê°„êµ¬í•©ë‹ˆë‹¤. ì´ ì¼ì„ ìœ„í•´ ê¸°ë„í•˜ë©°, ì£¼ë‹˜ì˜ ëœ»ì´ ì´ë£¨ì–´ì§€ê¸°ë¥¼ ë°”ëë‹ˆë‹¤. ì–´ë ¤ìš´ ìƒí™©ì—ì„œë„ ì£¼ë‹˜ì„ ì˜ì§€í•˜ë©°, ì£¼ë‹˜ì˜ ë„ì›€ì„ êµ¬í•©ë‹ˆë‹¤. ì˜ˆìˆ˜ë‹˜ì˜ ì´ë¦„ìœ¼ë¡œ ê¸°ë„í•©ë‹ˆë‹¤. ì•„ë©˜.",
  
  devotion: "ì˜¤ëŠ˜ í•˜ë£¨ë„ ì£¼ë‹˜ê³¼ í•¨ê»˜í•©ë‹ˆë‹¤. ì•„ì¹¨ì— ê¹¨ì–´ ì£¼ë‹˜ê»˜ ê°ì‚¬ë“œë¦¬ë©°, ìƒˆë¡œìš´ í•˜ë£¨ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ ì£¼ë‹˜ì˜ ì€í˜œê°€ ì¶©ë§Œí•˜ì‹œê¸°ë¥¼ ê¸°ë„í•˜ë©°, ëª¨ë“  ì¼ì—ì„œ ì£¼ë‹˜ì˜ ëœ»ì„ êµ¬í•©ë‹ˆë‹¤. ì£¼ë‹˜ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.",
  
  testimony: "í•˜ë‚˜ë‹˜ì˜ ì€í˜œë¥¼ ê°„ì¦í•©ë‹ˆë‹¤. ì–´ë ¤ìš´ ìƒí™©ì—ì„œ ì£¼ë‹˜ê»˜ì„œ í•¨ê»˜í•˜ì…¨ê³ , ë†€ë¼ìš´ ë°©ë²•ìœ¼ë¡œ ë„ìš°ì…¨ìŠµë‹ˆë‹¤. ì´ ëª¨ë“  ê²½í—˜ì„ í†µí•´ í•˜ë‚˜ë‹˜ì˜ ì‚¬ë‘ê³¼ ì‹ ì‹¤í•˜ì‹¬ì„ ë”ìš± ê¹Šì´ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤. ëª¨ë“  ì˜ê´‘ì„ í•˜ë‚˜ë‹˜ê»˜ ëŒë¦½ë‹ˆë‹¤.",
  
  reflection: "ì£¼ë‹˜ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ëŒì•„ë³´ë©° í•˜ë‚˜ë‹˜ì˜ ì€í˜œë¥¼ ê¸°ì–µí•©ë‹ˆë‹¤. ì‘ì€ ì¼ìƒ ì†ì—ì„œë„ ì£¼ë‹˜ì˜ ì‚¬ë‘ì„ ëŠë¼ë©°, ê°ì‚¬í•œ ë§ˆìŒìœ¼ë¡œ í•˜ë£¨ë¥¼ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤. ë‚´ì¼ë„ ì£¼ë‹˜ê³¼ í•¨ê»˜ ê±¸ì–´ê°€ê² ìŠµë‹ˆë‹¤."
};

function fillTemplate(type) {
  const textarea = document.getElementById('content-textarea');
  textarea.value = templates[type];
  updateCharCount();
  analyzeContent();
  
  // Set appropriate note type
  const noteTypeRadios = document.querySelectorAll('input[name="text_note[note_type]"]');
  noteTypeRadios.forEach(radio => {
    if ((type === 'prayer' && radio.value === 'prayer_request') ||
        (type === 'devotion' && radio.value === 'daily_devotion') ||
        (type === 'testimony' && radio.value === 'testimony') ||
        (type === 'reflection' && radio.value === 'personal_reflection')) {
      radio.checked = true;
    }
  });
}

// Character counting and estimation
function updateCharCount() {
  try {
    const textarea = document.getElementById('content-textarea');
    const charCount = document.getElementById('char-count');
    const estimatedDuration = document.getElementById('estimated-duration');
    
    if (!textarea || !charCount || !estimatedDuration) return;
    
    const length = textarea.value.length;
    const koreanChars = (textarea.value.match(/[\u3131-\u3163\uac00-\ud7a3]/g) || []).length;
    
    charCount.textContent = `${length}ì / 800ì`;
    
    // Estimate duration (Korean TTS ~3.5 chars per second)
    const duration = Math.max(Math.min(koreanChars / 3.5, 60), 10);
    estimatedDuration.textContent = `ì˜ˆìƒ ê¸¸ì´: ${duration.toFixed(1)}ì´ˆ`;
    
    // Update color based on length
    if (length > 800) {
      charCount.classList.add('text-red-500');
    } else if (length > 600) {
      charCount.classList.add('text-yellow-500');
    } else {
      charCount.classList.remove('text-red-500', 'text-yellow-500');
    }
  } catch (error) {
    console.warn('Error updating character count:', error);
  }
}

// AI Content Analysis
function analyzeContent() {
  try {
    const textarea = document.getElementById('content-textarea');
    const aiPreview = document.getElementById('ai-preview');
    
    if (!textarea || !aiPreview) return;
    
    const content = textarea.value;
    if (content.length < 10) {
      aiPreview.classList.add('hidden');
      return;
    }
  
  // Simple client-side theme detection
  const themeKeywords = {
    'golden_light': ['ì°¬ì–‘', 'ê²½ë°°', 'í• ë ë£¨ì•¼', 'ì˜ê´‘', 'ì°¬ì†¡'],
    'peaceful_blue': ['ê¸°ë„', 'ë¬µìƒ', 'í‰ì•ˆ', 'ê³ ìš”', 'ì¡°ìš©'],
    'sunset_worship': ['ì €ë…', 'ê°ì‚¬', 'í•˜ë£¨', 'ë§ˆê°', 'ì†Œë§'],
    'cross_pattern': ['ì‹­ìê°€', 'ë¯¿ìŒ', 'êµ¬ì›', 'ì„±ê²½', 'ë§ì”€'],
    'mountain_majesty': ['í˜', 'ì¸ë‚´', 'ì‚°', 'ê²¬ë””', 'ê°•í•¨'],
    'flowing_river': ['ìƒˆë¡œìš´', 'ìƒëª…', 'ì„¸ë¡€', 'ê±°ë“­', 'ìƒˆë¡­']
  };
  
  let detectedTheme = 'golden_light';
  let maxMatches = 0;
  
  Object.entries(themeKeywords).forEach(([theme, keywords]) => {
    const matches = keywords.filter(keyword => content.includes(keyword)).length;
    if (matches > maxMatches) {
      maxMatches = matches;
      detectedTheme = theme;
    }
  });
  
  // Type detection
  let detectedType = 'personal_reflection';
  if (content.includes('ê¸°ë„') || content.includes('ê°„êµ¬')) {
    detectedType = 'prayer_request';
  } else if (content.includes('ê°„ì¦') || content.includes('ì€í˜œ')) {
    detectedType = 'testimony';
  } else if (content.includes('ì˜¤ëŠ˜') || content.includes('í•˜ë£¨')) {
    detectedType = 'daily_devotion';
  } else if (content.includes('ì„±ê²½') || content.includes('ë§ì”€')) {
    detectedType = 'bible_study';
  }
  
  // Update preview
  const koreanChars = (content.match(/[\u3131-\u3163\uac00-\ud7a3]/g) || []).length;
  const duration = Math.max(Math.min(koreanChars / 3.5, 60), 10);
  
  document.getElementById('detected-theme').textContent = getThemeDisplay(detectedTheme);
  document.getElementById('detected-type').textContent = getTypeDisplay(detectedType);
  document.getElementById('korean-chars').textContent = `${koreanChars}ì`;
  document.getElementById('video-duration').textContent = `${duration.toFixed(1)}ì´ˆ`;
  
  document.getElementById('ai-preview').classList.remove('hidden');
  } catch (error) {
    console.warn('Error analyzing content:', error);
  }
}

// Helper functions
function getThemeDisplay(theme) {
  const themes = {
    'golden_light': 'ğŸŒŸ ì°¬ì–‘ê³¼ ê²½ë°°',
    'peaceful_blue': 'ğŸ•¯ï¸ ê¸°ë„ì™€ ë¬µìƒ',
    'sunset_worship': 'ğŸŒ… ì €ë… ê²½ê±´',
    'cross_pattern': 'âœï¸ ì„±ê²½ê³¼ ë¯¿ìŒ',
    'mountain_majesty': 'â›°ï¸ í˜ê³¼ ì¸ë‚´',
    'flowing_river': 'ğŸŒŠ ìƒˆë¡œìš´ ìƒëª…'
  };
  return themes[theme] || theme;
}

function getTypeDisplay(type) {
  const types = {
    'personal_reflection': 'ê°œì¸ ë¬µìƒ',
    'prayer_request': 'ê¸°ë„ ì œëª©',
    'bible_study': 'ì„±ê²½ ê³µë¶€',
    'daily_devotion': 'ì¼ì¼ ê²½ê±´',
    'testimony': 'ê°„ì¦',
    'sermon_note': 'ì„¤êµ ë…¸íŠ¸'
  };
  return types[type] || type;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  try {
    const textarea = document.getElementById('content-textarea');
    const form = document.getElementById('text-note-form');
    
    if (textarea) {
      textarea.addEventListener('input', function() {
        try {
          updateCharCount();
          clearTimeout(this.analyzeTimeout);
          this.analyzeTimeout = setTimeout(analyzeContent, 500);
        } catch (error) {
          console.error('Error in textarea input handler:', error);
        }
      });
      
      // Initialize
      updateCharCount();
    }
    
    // Enhanced form submission handling
    if (form) {
      form.addEventListener('submit', function(event) {
        try {
          console.log('Form submission started');
          // Additional validation can go here
          const content = textarea ? textarea.value.trim() : '';
          if (content.length < 10) {
            event.preventDefault();
            alert('ë‚´ìš©ì„ ìµœì†Œ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return false;
          }
          console.log('Form validation passed');
        } catch (error) {
          console.error('Error in form submission handler:', error);
          event.preventDefault();
          return false;
        }
      });
    }
    
    // Prevent any unhandled promise rejections from this page
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Page-specific Promise rejection caught:', event.reason);
      event.preventDefault(); // Prevent the error from propagating
    });
    
  } catch (error) {
    console.error('Error setting up text entry form:', error);
  }
});
</script>

<style>
/* Mobile-optimized responsive design */
@media (max-width: 640px) {
  .container {
    padding-left: 1rem;
    padding-right: 1rem;
  }
  
  .grid-cols-2 {
    grid-template-columns: repeat(1, minmax(0, 1fr));
  }
}

/* Enhanced focus states for mobile */
textarea:focus, input:focus {
  outline: none !important;
}

/* Template buttons hover effect */
.bg-blue-50 button:active {
  transform: scale(0.98);
}
</style>